<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reaction Diffusion</title>
    <style>
      body { margin: 0; }
      canvas { display: block; }
    </style>
  </head>
  <body>
    <script src="js/external/three.min.js"></script>
    <script src="js/external/GPUComputationRenderer.min.js"></script>
    <script src="js/external/SimplexNoise.js"></script>
    <script src="js/reaction-diffusion-fragment.js"></script>
    <script src="js/render-shaders.js"></script>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var simulation_width = Math.round(width / 2);
      var simulation_height = Math.round(height / 2);

      var scene = new THREE.Scene();

      var camera = new THREE.OrthographicCamera(width / - 2, width / 2, height / 2, height / - 2, 1, 1000);
      camera.position.z = 5;

      var renderer = new THREE.WebGLRenderer({precision: "highp"});
      renderer.setSize(width, height);
      document.body.appendChild(renderer.domElement);

      var geometry = new THREE.PlaneGeometry(width, height, 1, 1);
      var material = new THREE.ShaderMaterial
      ({ 
        vertexShader: render_vertex,
        fragmentShader: render_fragment,
        uniforms: { 
          "reaction_diffusion": { value: null }, 
          "color_map": { value: createColorMap() },
        }
      });
      var plane = new THREE.Mesh( geometry, material );
      scene.add(plane);

      var gpu_compute = new THREE.GPUComputationRenderer(simulation_width, simulation_height, renderer);

      var reaction_diffusion = gpu_compute.createTexture();

      setInitialState(reaction_diffusion);

      var reaction_diffusion_variable = gpu_compute.addVariable(
        "reaction_diffusion", 
        reaction_diffusion_fragment,
        reaction_diffusion
      );

      gpu_compute.setVariableDependencies(reaction_diffusion_variable, [reaction_diffusion_variable]);

      createEnvironment();

      reaction_diffusion_variable.material.uniforms['mouse_pos'] = { value: new THREE.Vector2(-100, -100) };
      reaction_diffusion_variable.material.uniforms['mouse_down'] = { value: false };

      renderer.domElement.onmousemove = function(event) 
      {
        var x = event.clientX * (simulation_width / width);
        var y = simulation_height - event.clientY * (simulation_height / height);

        reaction_diffusion_variable.material.uniforms['mouse_pos'].value = new THREE.Vector2(x, y);
      }

      renderer.domElement.onmousedown = function(event)
      {
        reaction_diffusion_variable.material.uniforms['mouse_down'].value = true;
      }

      renderer.domElement.onmouseup = function(event)
      {
        reaction_diffusion_variable.material.uniforms['mouse_down'].value = false;
      }

      reaction_diffusion_variable.wrapS = THREE.ClampToEdgeWrapping;
      reaction_diffusion_variable.wrapT = THREE.ClampToEdgeWrapping;

      gpu_compute.init();

      function animate() 
      {
        requestAnimationFrame(animate);
        render();
      }

      animate();
      
      function render()
      {
        simulateReactionDiffusion(8);
        material.uniforms["reaction_diffusion"].value = gpu_compute.getCurrentRenderTarget(reaction_diffusion_variable).texture;
        renderer.render(scene, camera);
      }

      function simulateReactionDiffusion(iterations)
      {
        for(var i = 0; i < iterations; i++)
        {
          gpu_compute.compute();
        }
      }

      function setInitialState(texture) 
      {
        // var pixels = texture.image.data;
        // var p = 0;
        // for (var y = 0; y < simulation_height; y++)
        // {
        //   for (var x = 0; x < simulation_width; x++ )
        //   {
        //     pixels[p + 0] = 0.5;
        //     pixels[p + 1] = 0;
        //     pixels[p + 2] = 0;
        //     pixels[p + 3] = 1;
        //     p += 4;
        //   }
        // }

        var min_radius = 10;
        var max_radius = 10;
        var points = new Array(1);
        for (var i = 0; i < points.length; i++) 
        {
          var radius = min_radius + Math.random() * (max_radius - min_radius);
          points[i] = [Math.random() * width, Math.random() * height, radius];
        }

        points[0] = [simulation_width / 2, simulation_height / 2, 16];

        function distance(p1, p2)
        {
          return Math.sqrt(Math.pow(p2[0] - p1[0], 2) + Math.pow(p2[1] - p1[1], 2));
        }

        var pixels = texture.image.data;
        var p = 0;
        for (var y = 0; y < simulation_height; y++)
        {
          for (var x = 0; x < simulation_width; x++ )
          {
            pixels[p + 0] = 0.7;
            pixels[p + 1] = 0;
            pixels[p + 2] = 0;
            pixels[p + 3] = 1;

            for (var i = 0; i < points.length; i++)
            {
              var dist = distance([x,y], points[i]);
              if(dist < points[i][2])
              {
                pixels[p + 1] = (points[i][2] - dist)/(points[i][2]*2);
              }
            }

            p += 4;
          }
        }
      }

      function createColorMap()
      {
        // var data = new Uint8Array([
        //   165,0,38,
        //   215,48,39,
        //   244,109,67,
        //   253,174,97,
        //   254,224,144,
        //   255,255,191,
        //   224,243,248,
        //   171,217,233,
        //   116,173,209,
        //   69,117,180,
        //   49,54,149
        // ]);

        var data = new Uint8Array([
          255,255,255,
          0,0,0,
          0,0,0,
          0,0,0,
          0,0,0
        ]);

        var color_map = new THREE.DataTexture(data, data.length / 3, 1, THREE.RGBFormat);
        color_map.magFilter = THREE.LinearFilter;
        color_map.minFilter = THREE.LinearFilter;

        return color_map;
      }

      function createEnvironment()
      {
        let simplex = new THREE.SimplexNoise();

        //let feed  = 0.072;
        //let kill  = 0.062;

        //let feed = 0.045;
        //let kill = 0.06;

        //let feed = 0.042;
        //let kill = 0.06;

        //let feed  = 0.014;
        //let kill  = 0.04;

        let feed  = 0.037;
        let kill  = 0.06;

        let scale = 1.0;

        // let feed_variation = 0.001;
        // let kill_variation = 0.001;
        // let scale_variation = 1.5;

        let feed_variation = 0.000;
        let kill_variation = 0.000;
        let scale_variation = 0.0;

        let noise_scale = 250;

        let pixels = new Float32Array(simulation_width * simulation_height * 4);
        let p = 0;
        for (let y = 0; y < simulation_height; y++)
        {
          for (let x = 0; x < simulation_width; x++ )
          {
            pixels[p + 0] = feed + feed_variation * simplex.noise3d(x / noise_scale, y / noise_scale, 0);
            pixels[p + 1] = kill + kill_variation * simplex.noise3d(x / noise_scale, y / noise_scale, 10);
            pixels[p + 2] = scale + scale_variation * simplex.noise3d(x / noise_scale, y / noise_scale, 20);
            pixels[p + 3] = Math.PI * simplex.noise3d(x / noise_scale, y / noise_scale, 30);
            p += 4;
          }
        }

        reaction_diffusion_variable.material.uniforms['environment'] = { 
          value: new THREE.DataTexture(pixels, simulation_width, simulation_height, THREE.RGBAFormat, THREE.FloatType) 
        };

        reaction_diffusion_variable.material.uniforms.environment.value.magFilter = THREE.LinearFilter;
        reaction_diffusion_variable.material.uniforms.environment.value.minFilter = THREE.LinearFilter;
      }

    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-156004912-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>